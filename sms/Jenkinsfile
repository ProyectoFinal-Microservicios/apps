pipeline {
    agent {
        docker {
            image 'python:3.11-slim'
            args '-u root'
        }
    }

    environment {
        SONAR_HOST_URL = 'http://sonarqube:9000'
        SONAR_TOKEN = credentials('sonar-token')
        RABBITMQ_URL = 'amqp://admin:securepass@rabbitmq:5672'
        TWILIO_ACCOUNT_SID=credentials('TWILIO_ACCOUNT_SID')
        TWILIO_AUTH_TOKEN=credentials('TWILIO_AUTH_TOKEN')
        TWILIO_PHONE_NUMBER= credentials('TWILIO_PHONE_NUMBER')
    }

    stages {
        stage('üîç Checkout') {
            steps {
                checkout scm
                sh 'pwd'
                sh 'ls -la'
            }
        }

        stage('Install Dependencies') {
            steps {
                sh 'ls -la'
                dir('sms') {
                    sh 'python3 --version'
                    sh 'python3 --version'
                    sh 'pip install -r requirements.txt'
                }
            }
        }

        stage('Unit Tests') {
            steps {
                dir('sms/tests/unit') {
                    sh 'python -m pytest test_consumer.py -v --junitxml=test-results.xml || true'
                }
            }
        }

        stage('Integration Tests') {
            steps {
                script {
                    // Esperar a que RabbitMQ est√© disponible
                    sh '''
                        cd sms/tests/unit
                        # Enviar mensaje de prueba al bus
                        python test_sms.py "+573001234567" "Mensaje de integraci√≥n desde Jenkins" || true
                    '''
                }
            }
        }

        stage('Coverage Report') {
            steps {
                sh '''
                    cd sms
                    python -m pytest test_consumer.py --cov=consumer --cov-report=xml --cov-report=html || true
                '''
            }
            post {
                always {
                    publishCoverage adapters: [coberturaAdapter('sms/coverage.xml')]
                }
            }
        }

        stage('SonarQube Analysis') {
            steps {
                script {
                    def scannerHome = tool 'sonar-scanner-python'
                    withSonarQubeEnv('sonarqube') {
                        sh '''
                            cd sms
                            ${scannerHome}/bin/sonar-scanner \
                                -Dsonar.projectKey=sms-service \
                                -Dsonar.projectName="SMS Notification Service" \
                                -Dsonar.sources=. \
                                -Dsonar.tests=. \
                                -Dsonar.test.inclusions=test_*.py \
                                -Dsonar.python.coverage.reportPaths=coverage.xml \
                                -Dsonar.python.xunit.reportPath=test-results.xml || true
                        '''
                    }
                }
            }
        }
        // Quality Gate and Docker build/deploy stages removed per request.
    }
}