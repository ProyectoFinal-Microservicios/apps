pipeline {
    agent any

    environment {
        SONAR_HOST_URL = credentials('sonar-host-url')
        SONAR_TOKEN = credentials('sonar-token')
        RABBITMQ_URL = 'amqp://admin:securepass@rabbitmq:5672'
        TWILIO_ACCOUNT_SID = credentials('twilio-account-sid')
        TWILIO_AUTH_TOKEN = credentials('twilio-auth-token')
        TWILIO_PHONE_NUMBER = credentials('twilio-phone-number')
    }

    stages {
        stage('Checkout') {
            steps {
                checkout scm
            }
        }

        stage('Install Dependencies') {
            steps {
                sh '''
                    cd sms
                    pip install -r requirements.txt
                '''
            }
        }

        stage('Unit Tests') {
            steps {
                sh '''
                    cd sms
                    python -m pytest test_consumer.py -v --junitxml=test-results.xml || true
                '''
            }
            post {
                always {
                    junit 'sms/test-results.xml'
                }
            }
        }

        stage('Integration Tests') {
            steps {
                script {
                    // Esperar a que RabbitMQ esté disponible
                    sh '''
                        cd sms
                        # Enviar mensaje de prueba al bus
                        python test_sms.py "+573001234567" "Mensaje de integración desde Jenkins" || true
                    '''
                }
            }
        }

        stage('Coverage Report') {
            steps {
                sh '''
                    cd sms
                    python -m pytest test_consumer.py --cov=consumer --cov-report=xml --cov-report=html || true
                '''
            }
            post {
                always {
                    publishCoverage adapters: [coberturaAdapter('sms/coverage.xml')]
                }
            }
        }

        stage('SonarQube Analysis') {
            steps {
                script {
                    def scannerHome = tool 'sonar-scanner-python'
                    withSonarQubeEnv('sonarqube') {
                        sh """
                            cd sms
                            ${scannerHome}/bin/sonar-scanner \\
                                -Dsonar.projectKey=sms-service \\
                                -Dsonar.projectName='SMS Notification Service' \\
                                -Dsonar.sources=. \\
                                -Dsonar.tests=. \\
                                -Dsonar.test.inclusions=test_*.py \\
                                -Dsonar.python.coverage.reportPaths=coverage.xml \\
                                -Dsonar.python.xunit.reportPath=test-results.xml
                        """ || true
                        
                    }
                }
            }
        }
        // Quality Gate and Docker build/deploy stages removed per request.
    }

    post {
        always {
            sh '''
                cd sms
                # Limpiar archivos temporales
                rm -f test-results.xml coverage.xml
                rm -rf htmlcov
            '''
        }
        success {
            echo 'Pipeline completed successfully!'
        }
        failure {
            echo 'Pipeline failed!'
        }
    }
}