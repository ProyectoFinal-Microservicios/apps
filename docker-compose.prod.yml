version: "3.9"

networks:
  retos-net:
    driver: bridge

services:
  db:
    image: postgres:16-alpine
    container_name: retos-postgres
    networks:
      - retos-net
    environment:
      POSTGRES_DB: ${DB_NAME:-retos_microservicios}
      POSTGRES_USER: ${DB_USER:-postgres}
      POSTGRES_PASSWORD: ${DB_PASS:-securepassword}
    ports:
      - "5432:5432"

  auth:
    image: ghcr.io/proyectofinal-microservicios/auth:latest
    networks:
      - retos-net
    ports:
      - "3500:3500"
    environment:
      DB_HOST: ${DB_HOST:-db}
      DB_PORT: ${DB_PORT:-5432}
      DB_NAME: ${DB_NAME:-retos_microservicios}
      DB_USER: ${DB_USER:-postgres}
      DB_PASS: ${DB_PASS:-securepassword}
      DB_SCHEMA: ${DB_SCHEMA:-auth}
    depends_on:
      - db

  profiles:
    image: ghcr.io/proyectofinal-microservicios/profiles:latest
    networks:
      - retos-net
    ports:
      - "8000:8000"
    environment:
      DB_HOST: ${DB_HOST:-db}
      DB_PORT: ${DB_PORT:-5432}
      DB_NAME: ${DB_NAME:-retos_microservicios}
      DB_USER: ${DB_USER:-postgres}
      DB_PASS: ${DB_PASS:-securepassword}
      DB_SCHEMA: ${DB_SCHEMA:-auth}
    depends_on:
      - db

  sms:
    image: ghcr.io/proyectofinal-microservicios/sms:latest
    networks:
      - retos-net
    ports:
      - "6379:6379"
    environment:
      # RabbitMQ â€” variables de entorno con valores por defecto tomados de .env.example
      RABBITMQ_URL: "${RABBITMQ_URL:-amqp://admin:securepass@rabbitmq:5672}"
      RABBITMQ_HOST: ${RABBITMQ_HOST:-rabbitmq}
      RABBITMQ_PORT: ${RABBITMQ_PORT:-5672}
      RABBITMQ_USER: ${RABBITMQ_USER:-admin}
      RABBITMQ_PASSWORD: ${RABBITMQ_PASSWORD:-securepass}
      RABBITMQ_VHOST: ${RABBITMQ_VHOST:-/}
      # Exchange usado para eventos de auth
      AUTH_EVENTS_EXCHANGE: ${AUTH_EVENTS_EXCHANGE:-auth.events}
    depends_on:
      - db
