pipeline {
    agent any

    tools {
        nodejs "nodeForAuth"
    }

    environment {
        SONARQUBE_ENV = 'sonarqube'
    }

    stages {
        stage('游댌 Checkout') {
            steps {
                echo "==========================================="
                echo "游닌 Clonando repositorio..."
                echo "==========================================="
                checkout scm
            }
        }

    // El stage para generar un token en SonarQube se ha eliminado porque
    // el token ya se gestiona desde la UI de Jenkins (Credentials).
    // Si necesitas regenerarlo desde pipeline, podemos volver a a침adir
    // la l칩gica aqu칤, pero no es necesario cuando la credencial existe.

        stage('游닍 Install dependencies') {
            steps {
                sh 'pwd'
                echo "==========================================="
                echo "游닍 Instalando dependencias de Node.js..."
                echo "==========================================="
                sh 'node --version'
                sh 'npm --version'
                dir('auth') {
                    sh 'npm install'
                }
            }
        }

        stage('游빍 Run tests') {
            steps {
                echo "==========================================="
                echo "游빍 Ejecutando pruebas unitarias..."
                echo "==========================================="
                sh 'npm test || echo "Tests skipped"' // opcional si a칰n no tienes tests
            }
        }

        stage('游댌 SonarQube Analysis') {
            steps {
                echo "==========================================="
                echo "游댌 Analizando calidad de c칩digo con SonarQube..."
                echo "==========================================="

                script {
                    withSonarQubeEnv("${SONARQUBE_ENV}") {
                        def scannerHome = tool 'sonarForAuth'
                        sh """
                            ${scannerHome}/bin/sonar-scanner \
                                -Dsonar.projectKey=auth-service \
                                -Dsonar.sources=auth \
                                -Dsonar.host.url=$SONAR_HOST_URL \
                                -Dsonar.login=$SONAR_AUTH_TOKEN
                        """
                    }
                }
            }
        }



        stage('游뚽 Quality Gate') {
            steps {
                echo "==========================================="
                echo "游뚽 Verificando Quality Gate de SonarQube..."
                echo "==========================================="

                timeout(time: 10, unit: 'MINUTES') {
                    waitForQualityGate abortPipeline: true
                }
            }
        }
    }
}
