/**
 * Jenkinsfile para Auth Service (Node.js)
 * 
 * Pipeline de CI/CD que incluye:
 * - Checkout del c√≥digo
 * - Instalaci√≥n de dependencias
 * - Ejecuci√≥n de pruebas unitarias
 * - An√°lisis de calidad con SonarQube
 * - Construcci√≥n de imagen Docker
 * - Publicaci√≥n de reportes
 */

pipeline {
    agent any
    
    tools {
        nodejs 'NodeJS18'
    }
    
    environment {
        // Variables de entorno
        SERVICE_NAME = 'auth-service'
        SERVICE_DIR = 'auth'
        SONAR_HOST_URL = 'http://sonarqube:9000'
        DOCKER_IMAGE_NAME = 'auth-service'
        BUILD_VERSION = "${env.BUILD_NUMBER}"
    }
    
    options {
        // Opciones del pipeline
        buildDiscarder(logRotator(numToKeepStr: '10'))
        timestamps()
        timeout(time: 30, unit: 'MINUTES')
        ansiColor('xterm')
    }
    
    stages {
        
        // ============================================
        // STAGE 1: CHECKOUT
        // ============================================
        stage('üîç Checkout') {
            steps {
                echo "==========================================="
                echo "üì• Clonando repositorio..."
                echo "==========================================="
                checkout scm
                
                script {
                    // Mostrar informaci√≥n del commit
                    sh """
                        echo "Branch: \${GIT_BRANCH}"
                        echo "Commit: \${GIT_COMMIT}"
                        git log -1 --pretty=format:'%an - %s' || true
                    """
                }
            }
        }
        
        // ============================================
        // STAGE 2: INSTALACI√ìN DE DEPENDENCIAS
        // ============================================
        stage('üì¶ Install Dependencies') {
            steps {
                echo "==========================================="
                echo "üì¶ Instalando dependencias de Node.js..."
                echo "==========================================="
                
                dir(SERVICE_DIR) {
                    sh 'node --version'
                    sh 'npm --version'
                    sh 'npm ci --prefer-offline --no-audit'
                }
            }
        }
        
        // ============================================
        // STAGE 3: LINT (Opcional)
        // ============================================
        stage('üîç Code Linting') {
            steps {
                echo "==========================================="
                echo "üîç Verificando estilo de c√≥digo..."
                echo "==========================================="
                
                dir(SERVICE_DIR) {
                    script {
                        // Si existe ESLint configurado, ejecutarlo
                        def eslintExists = fileExists('package.json')
                        if (eslintExists) {
                            def packageJson = readJSON file: 'package.json'
                            if (packageJson.scripts?.lint) {
                                sh 'npm run lint || true'
                            } else {
                                echo "‚ö†Ô∏è No se encontr√≥ script 'lint' en package.json"
                            }
                        }
                    }
                }
            }
        }
        
        // ============================================
        // STAGE 4: PRUEBAS UNITARIAS
        // ============================================
        stage('üß™ Unit Tests') {
            steps {
                echo "==========================================="
                echo "üß™ Ejecutando pruebas unitarias..."
                echo "==========================================="
                
                dir(SERVICE_DIR) {
                    script {
                        // Ejecutar tests si existen
                        def packageJson = readJSON file: 'package.json'
                        if (packageJson.scripts?.test) {
                            sh 'npm test -- --coverage --ci --reporters=default --reporters=jest-junit || true'
                        } else {
                            echo "‚ö†Ô∏è No se encontr√≥ script 'test' en package.json"
                            echo "‚ö†Ô∏è Creando reporte de pruebas vac√≠o..."
                        }
                    }
                }
            }
        }
        
        // ============================================
        // STAGE 5: AN√ÅLISIS DE SONARQUBE
        // ============================================
        stage('üîç SonarQube Analysis') {
            steps {
                echo "==========================================="
                echo "üîç Analizando calidad de c√≥digo con SonarQube..."
                echo "==========================================="
                
                dir(SERVICE_DIR) {
                    script {
                        // Crear sonar-project.properties si no existe
                        if (!fileExists('sonar-project.properties')) {
                            writeFile file: 'sonar-project.properties', 
                            text: """
                            sonar.projectKey=auth-service
                            sonar.projectName=Authentication Service
                            sonar.projectVersion=1.0
                            sonar.sources=.
                            sonar.exclusions=node_modules/**,tests/**,coverage/**,**/*.test.js,**/*.spec.js
                            sonar.javascript.lcov.reportPaths=coverage/lcov.info
                            sonar.sourceEncoding=UTF-8
                            """
                            }
                                                
                            // Ejecutar an√°lisis de SonarQube
                        withSonarQubeEnv('SonarQube') {
                        sh """
                        sonar-scanner \
                        -Dsonar.projectKey=auth-service \
                        -Dsonar.sources=. \
                        -Dsonar.host.url=${SONAR_HOST_URL} \
                        -Dsonar.exclusions=node_modules/**,tests/**,coverage/** || true
                        """
                        }
                    }
                }
            }
        }
        
        // ============================================
        // STAGE 6: QUALITY GATE
        // ============================================
        stage('üö¶ Quality Gate') {
            steps {
                echo "==========================================="
                echo "üö¶ Verificando Quality Gate de SonarQube..."
                echo "==========================================="
                
                script {
                    timeout(time: 5, unit: 'MINUTES') {
                        try {
                            def qg = waitForQualityGate()
                            if (qg.status != 'OK') {
                                echo "‚ö†Ô∏è Quality Gate fall√≥: ${qg.status}"
                                echo "‚ö†Ô∏è Continuando pipeline pero revisa los resultados en SonarQube"
                                // No abortamos el pipeline, solo advertimos
                            } else {
                                echo "‚úÖ Quality Gate aprobado"
                            }
                        } catch (Exception e) {
                            echo "‚ö†Ô∏è Error verificando Quality Gate: ${e.message}"
                            echo "‚ö†Ô∏è Continuando pipeline..."
                        }
                    }
                }
            }
        }
        
        // ============================================
        // STAGE 7: BUILD DOCKER IMAGE
        // ============================================
        stage('üê≥ Build Docker Image') {
            steps {
                echo "==========================================="
                echo "üê≥ Construyendo imagen Docker..."
                echo "==========================================="
                
                dir(SERVICE_DIR) {
                    script {
                        // Construir imagen Docker
                        sh """
                            docker build -t ${DOCKER_IMAGE_NAME}:${BUILD_VERSION} .
                            docker tag ${DOCKER_IMAGE_NAME}:${BUILD_VERSION} ${DOCKER_IMAGE_NAME}:latest
                        """
                        
                        echo "‚úÖ Imagen construida: ${DOCKER_IMAGE_NAME}:${BUILD_VERSION}"
                        echo "‚úÖ Tag: ${DOCKER_IMAGE_NAME}:latest"
                    }
                }
            }
        }
        
        // ============================================
        // STAGE 8: PRUEBAS DE INTEGRACI√ìN (Opcional)
        // ============================================
        stage('üîó Integration Tests') {
            steps {
                echo "==========================================="
                echo "üîó Ejecutando pruebas de integraci√≥n..."
                echo "==========================================="
                
                script {
                    // Verificar si existen pruebas de integraci√≥n
                    if (fileExists('tests/feature/auth.feature')) {
                        echo "üìù Pruebas de integraci√≥n encontradas"
                        echo "‚ö†Ô∏è Ejecutar con docker-compose en ambiente de testing"
                        // Aqu√≠ se pueden ejecutar pruebas con Cucumber/Behave
                    } else {
                        echo "‚ÑπÔ∏è No se encontraron pruebas de integraci√≥n"
                    }
                }
            }
        }
    }
    
    // ============================================
    // POST-BUILD ACTIONS
    // ============================================
    post {
        always {
            echo "==========================================="
            echo "üìä Publicando reportes..."
            echo "==========================================="
            
            dir(SERVICE_DIR) {
                // Publicar resultados de JUnit
                junit allowEmptyResults: true, testResults: '**/junit.xml, **/test-results/*.xml'
                
                // Publicar reporte de cobertura
                publishHTML([
                    allowMissing: true,
                    alwaysLinkToLastBuild: true,
                    keepAll: true,
                    reportDir: 'coverage/lcov-report',
                    reportFiles: 'index.html',
                    reportName: 'Coverage Report',
                    reportTitles: 'Code Coverage'
                ])
                
                // Limpiar workspace si es necesario
                // cleanWs()
            }
        }
        
        success {
            echo "==========================================="
            echo "‚úÖ Pipeline ejecutado exitosamente!"
            echo "==========================================="
            echo "Build #${BUILD_NUMBER} completado"
            echo "Servicio: ${SERVICE_NAME}"
            echo "Imagen Docker: ${DOCKER_IMAGE_NAME}:${BUILD_VERSION}"
        }
        
        failure {
            echo "==========================================="
            echo "‚ùå Pipeline fall√≥!"
            echo "==========================================="
            echo "Build #${BUILD_NUMBER} fall√≥"
            echo "Servicio: ${SERVICE_NAME}"
            echo "Revisa los logs para m√°s detalles"
        }
        
        unstable {
            echo "==========================================="
            echo "‚ö†Ô∏è Pipeline inestable"
            echo "==========================================="
            echo "Algunas pruebas fallaron o el Quality Gate no pas√≥"
        }
    }
}
